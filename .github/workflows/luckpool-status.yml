name: Telegram /status Bot (Luckpool)

on:
  schedule:
    - cron: "*/5 * * * *"  # Setiap 5 menit
  workflow_dispatch:

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run Telegram Bot
        shell: bash
        run: |
          # Konfigurasi variabel (langsung isi di sini)
          TG_TOKEN="7548058927:AAF-fL3P6W5sNxbzbmwwtsfVxPZubdIybzc"
          CHAT_ID="5763229296"
          WALLET="RGVmtuvrP2yX8q3U4up77CcSpkcVhp4bUG"

          OFFSET=0
          END_TIME=$((SECONDS + 3300))  # 55 menit

          while [ $SECONDS -lt $END_TIME ]; do
            RESP=$(curl -s "https://api.telegram.org/bot${TG_TOKEN}/getUpdates?timeout=20&offset=$OFFSET")
            COUNT=$(echo "$RESP" | jq '.result | length')

            if [ "$COUNT" -gt 0 ]; then
              for row in $(echo "$RESP" | jq -c '.result[]'); do
                ID=$(echo "$row" | jq '.update_id')
                MSG_TEXT=$(echo "$row" | jq -r '.message.text // empty')
                FROM_ID=$(echo "$row" | jq -r '.message.chat.id')

                OFFSET=$((ID + 1))

                if [ "$MSG_TEXT" = "/status" ] && [ "$FROM_ID" = "$CHAT_ID" ]; then
                  DATA=$(curl -s "https://luckpool.net/verus/stats_address?address=$WALLET")
                  WORKER_COUNT=$(echo "$DATA" | jq '.workers | length')

                  if [ "$WORKER_COUNT" -gt 0 ]; then
                    WORKERS=$(echo "$DATA" | jq -r '.workers[] | "\(.name): \(.hashrate) H/s"' | sed ':a;N;$!ba;s/\n/\\n/g')
                    TOTAL=$(echo "$DATA" | jq -r '.hashrate')
                    MESSAGE="Luckpool Workers:\n${WORKERS}\n\nTotal Hashrate: ${TOTAL} H/s"
                  else
                    MESSAGE="No active workers for wallet: $WALLET"
                  fi

                  cu
