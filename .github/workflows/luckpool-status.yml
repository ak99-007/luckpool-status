name: Telegram /status Bot (Luckpool)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y jq curl

      - name: Run /status bot
        run: |
          # === Variabel Langsung ===
          TG_TOKEN="7548058927:AAF-fL3P6W5sNxbzbmwwtsfVxPZubdIybzc"
          CHAT_ID="5763229296"
          WALLET="RGVmtuvrP2yX8q3U4up77CcSpkcVhp4bUG"
          OFFSET=0
          END_TIME=$((SECONDS + 3300))  # Loop max 55 menit

          while [ $SECONDS -lt $END_TIME ]; do
            RESP=$(curl -s "https://api.telegram.org/bot${TG_TOKEN}/getUpdates?timeout=20&offset=${OFFSET}")
            COUNT=$(echo "$RESP" | jq '.result | length' 2>/dev/null)

            if [ "$COUNT" -gt 0 ]; then
              for row in $(echo "$RESP" | jq -c '.result[]'); do
                ID=$(echo "$row" | jq '.update_id')
                MSG_TEXT=$(echo "$row" | jq -r '.message.text // empty')
                FROM_ID=$(echo "$row" | jq -r '.message.chat.id')

                OFFSET=$((ID + 1))

                if [[ "$MSG_TEXT" == "/status" && "$FROM_ID" == "$CHAT_ID" ]]; then
                  DATA=$(curl -s "https://luckpool.net/verus/stats_address?address=${WALLET}")
                  
                  # Cek apakah respons valid JSON
                  if echo "$DATA" | jq . >/dev/null 2>&1; then
                    WORKER_COUNT=$(echo "$DATA" | jq '.workers | length')

                    if [ "$WORKER_COUNT" -gt 0 ]; then
                      WORKERS=$(echo "$DATA" | jq -r '.workers[] | "\(.name): \(.hashrate) H/s"' | sed ':a;N;$!ba;s/\n/\\n/g')
                      TOTAL=$(echo "$DATA" | jq -r '.hashrate')
                      MESSAGE="üíª *Luckpool Workers:*\n${WORKERS}\n\nüìä *Total Hashrate:* ${TOTAL} H/s"
                    else
                      MESSAGE="‚ö†Ô∏è Tidak ada worker aktif.\nWallet:\n\`${WALLET}\`"
                    fi
                  else
                    MESSAGE="‚ùå Gagal mengambil data dari Luckpool.\nWallet:\n\`${WALLET}\`"
                  fi

                  curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                    -d chat_id="${CHAT_ID}" \
                    -d parse_mode=Markdown \
                    -d text="$MESSAGE"
                fi
              done
            fi
            sleep 5
          done
