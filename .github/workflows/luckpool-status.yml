name: Verus Worker Status Monitor

on:
  schedule:
    - cron: "*/5 * * * *"  # Setiap 5 menit
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Cek Worker Luckpool & Kirim Telegram
        run: |
          # === Konfigurasi Langsung di Sini ===
          WALLET="RGVmtuvrP2yX8q3U4up77CcSpkcVhp4bUG"
          TELEGRAM_TOKEN="7548058927:AAF-fL3P6W5sNxbzbmwwtsfVxPZubdIybzc"
          TELEGRAM_CHAT_ID="5763229296"

          URL="https://luckpool.net/verus/stats_address?address=${WALLET}"
          DATA=$(curl -s "$URL")

          # Cek apakah response valid dan mengandung informasi worker
          if echo "$DATA" | grep -q '"workers"'; then
            COUNT=$(echo "$DATA" | jq '.workers | to_entries | map(select(.value.hashrate > 0)) | length')
            DETAIL=$(echo "$DATA" | jq -r '.workers | to_entries[] | select(.value.hashrate > 0) | "\(.key): \(.value.hashrate) H/s"' | sed ':a;N;$!ba;s/\n/\n📟 /g')

            MESSAGE="✅ *${COUNT} Worker aktif* di Luckpool\n\n📟 ${DETAIL}\n\n👛 \`${WALLET}\`"
          else
            SHORT=$(echo "$DATA" | head -c 300 | sed 's/`/ /g')
            MESSAGE="⚠️ *Gagal mengambil data dari Luckpool*\n\n📤 *Respons:*\n\`\`\`\n${SHORT}\n\`\`\`"
          fi

          # Kirim ke Telegram
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=Markdown \
            -d text="$MESSAGE"
