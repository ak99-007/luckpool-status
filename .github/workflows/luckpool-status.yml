name: Telegram /status Bot (Luckpool)

on:
  schedule:
    - cron: "*/15 * * * *"          # start setiap 15 menit
  workflow_dispatch:                # bisa dijalankan manual

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 55             # jalankan ~55 menit lalu mati; cron berikutnya akan hidup lagi

    steps:
      - name: Install deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Run polling bot
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID:  ${{ secrets.TELEGRAM_CHAT_ID }}
          WALLET:   ${{ secrets.WALLET }}
        run: |
          OFFSET=0
          until [ $SECONDS -ge 3300 ]; do   # loop ~55 menit (3300 s)
            # Ambil update baru
            RESP=$(curl -s "https://api.telegram.org/bot${TG_TOKEN}/getUpdates?timeout=30&offset=$OFFSET")
            UPDATE_COUNT=$(echo "$RESP" | jq '.result | length')

            if [ "$UPDATE_COUNT" -gt 0 ]; then
              for row in $(echo "$RESP" | jq -r '.result[] | @base64'); do
                _jq() { echo "$row" | base64 -d | jq -r "$1"; }
                ID=$(_jq '.update_id')
                TEXT=$(_jq '.message.text // empty')
                FROM=$(_jq '.message.chat.id')

                OFFSET=$((ID+1))   # set offset untuk next poll

                # Hanya respon jika pesan "/status" dan dari CHAT_ID yang diizinkan
                if [ "$TEXT" = "/status" ] && [ "$FROM" = "$CHAT_ID" ]; then
                  # hit Luckpool API
                  JSON=$(curl -s "https://luckpool.net/verus/stats_address?address=$WALLET")
                  if echo "$JSON" | jq -e '.workers | length>0' >/dev/null; then
                    WORKERS=$(echo "$JSON" | jq -r '.workers[] | "\(.name): \(.hashrate) H/s"' | sed ':a;N;$!ba;s/\n/\\n/g')
                    TOTAL=$(echo "$JSON" | jq -r '.hashrate')
                    MSG="💠 *Luckpool Workers*\n${WORKERS}\n\n📊 *Total Hash:* ${TOTAL} H/s"
                  else
                    MSG="⚠️ *No active workers* for \`$WALLET\`"
                  fi
                  curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                    -d chat_id="$CHAT_ID" -d parse_mode=Markdown -d text="$MSG" > /dev/null
                fi
              done
            fi
            sleep 5
          done
