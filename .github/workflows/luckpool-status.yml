name: Verus Worker Status Monitor

on:
  schedule:
    - cron: "*/5 * * * *"  # Setiap 5 menit
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y jq curl

      - name: Check Luckpool Worker Status
        run: |
          # === Konfigurasi ===
          WALLET="RGVmtuvrP2yX8q3U4up77CcSpkcVhp4bUG"
          TELEGRAM_TOKEN="7548058927:AAF-fL3P6W5sNxbzbmwwtsfVxPZubdIybzc"
          TELEGRAM_CHAT_ID="5763229296"

          API_URL="https://luckpool.net/verus/api/miner/address?address=${WALLET}"
          DATA=$(curl -s "$API_URL")

          # Cek JSON valid
          if echo "$DATA" | jq . >/dev/null 2>&1; then
            WORKERS=$(echo "$DATA" | jq -r '.workers | to_entries[] | "\(.key): \(.value.hashrate) H/s"' | sed ':a;N;$!ba;s/\n/\\nüìü /g')
            COUNT=$(echo "$DATA" | jq '.workers | to_entries | length')

            # Buat pesan
            if [ "$COUNT" -gt 0 ]; then
              MESSAGE="‚úÖ *${COUNT} Worker aktif* di Luckpool:\nüìü ${WORKERS}"
            else
              MESSAGE="‚ö†Ô∏è Tidak ada worker aktif.\nWallet:\n\`${WALLET}\`"
            fi
          else
            SHORT=$(echo "$DATA" | head -c 300 | sed 's/`/ /g')
            MESSAGE="‚ùå Gagal mengambil data dari Luckpool API.\n\nRespons:\n\`\`\`\n${SHORT}\n\`\`\`"
          fi

          # Kirim ke Telegram
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=Markdown \
            -d text="$MESSAGE"
